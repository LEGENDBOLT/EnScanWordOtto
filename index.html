<!DOCTYPE html>
<html lang="it">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Studio Inglese: Flashcard & Quiz</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <style>
       body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
       .view { display: none; }
       .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
       @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
       .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
       .is-flipped { transform: rotateY(180deg); }
       .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
       .flashcard-back { transform: rotateY(180deg); }
       .modal-dialog { transition: transform 0.3s ease-out, opacity 0.3s ease-out; transform: scale(0.95); opacity: 0; visibility: hidden; }
       .modal-dialog.show { transform: scale(1); opacity: 1; visibility: visible; }
       .text-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 40; }
       .quiz-option, .match-option { transition: all 0.2s ease-in-out; }
       .quiz-option:hover, .match-option:hover { transform: scale(1.02); }
       .match-option.selected { border-color: #3b82f6; border-width: 4px; transform: scale(1.05); }
       .match-option.matched { background-color: #10b981; color: white; pointer-events: none; opacity: 0.6; transform: scale(1.02); border-color: #10b981; }
       .quiz-option.selected-correct { background-color: #d1fae5; border-color: #10b981; border-width: 4px; }
       .quiz-option.selected-incorrect { background-color: #fee2e2; border-color: #ef4444; border-width: 4px; }
       .quiz-option.correct-answer { background-color: #d1fae5; border-color: #10b981; border-width: 4px; }
       #chat-window, #quick-chat-window { height: 300px; overflow-y: auto; }
       .user-message { text-align: right; }
       .user-message .message-bubble { background-color: #3b82f6; color: white; }
       .bot-message .message-bubble { background-color: #e5e7eb; color: #1f2937; }
       .message-bubble { display: inline-block; padding: 0.5rem 1rem; border-radius: 1.25rem; max-width: 80%; margin-top: 0.5rem; text-align: left; }
   </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

   <main class="w-full max-w-md mx-auto relative">
       <button id="settings-btn" class="absolute top-4 right-4 bg-gray-200 hover:bg-gray-300 text-gray-700 w-10 h-10 rounded-full flex items-center justify-center transition-transform transform hover:rotate-90 z-20">
           <i class="fas fa-cog"></i>
       </button>

       <!-- VISTA 1: INSERIMENTO DATI / GESTIONE LISTE -->
       <div id="data-entry-view" class="view w-full">
           <div class="bg-white p-6 rounded-2xl shadow-lg">
               <h1 class="text-2xl font-bold text-center mb-2">Prepara il tuo Studio</h1>
               <p class="text-center text-gray-500 mb-4">Incolla la tua lista (`Inglese==Italiano`) o creane una con l'AI.</p>

               <div id="api-key-container-main" class="mb-4 p-4 bg-gray-100 rounded-lg">
                    <label for="api-key-input-main" class="block text-sm font-medium text-gray-700 mb-1">Chiave API Google AI:</label>
                    <input type="password" id="api-key-input-main" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Incolla la tua chiave API qui">
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="save-api-key-checkbox-main" class="form-checkbox h-4 w-4 text-indigo-600">
                        <label for="save-api-key-checkbox-main" class="ml-2 block text-sm text-gray-900">Salva chiave API (nel browser)</label>
                    </div>
                </div>

               <div id="list-selection-container" class="mb-4">
                   <h2 class="text-lg font-semibold mb-2">Seleziona una lista salvata:</h2>
                   <select id="saved-lists-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                   <div class="grid grid-cols-2 gap-2 mt-2">
                        <button id="load-saved-list-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Carica Lista</button>
                        <button id="delete-list-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Cancella Lista</button>
                   </div>
               </div>
               <hr class="my-4">

               <h2 class="text-lg font-semibold mb-2">Oppure crea una nuova lista:</h2>
               <textarea id="data-input" class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Es. Hello==Ciao"></textarea>
               <div class="grid grid-cols-2 gap-2 mt-4">
                   <button id="load-data-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Inizia a Studiare</button>
                   <button id="ai-generate-list-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Chiedi all'AI</button>
               </div>
               <p id="data-error" class="text-red-500 text-center mt-2 hidden">Per favore, inserisci dei dati validi (almeno 4 voci per i giochi).</p>
           </div>
       </div>

       <!-- VISTA 2: SELEZIONE MODALITÀ -->
       <div id="mode-selection-view" class="view w-full">
           <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
               <h1 class="text-2xl font-bold mb-4">Scegli una Modalità</h1>
               <div class="flex flex-col gap-4">
                   <button id="select-flashcard-mode" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Modalità Flashcard</button>
                   <button id="select-quiz-mode" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Modalità Quiz</button>
                   <button id="select-match-mode" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Abbina le Coppie</button>
                    <button id="select-chat-mode" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">Pratica con l'AI</button>
                   <button id="select-review-mode" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 hidden">Rivedi Errori</button>
               </div>
               <button id="back-to-data-btn" class="mt-6 text-gray-500 hover:text-blue-600 transition">← Cambia lista</button>
           </div>
       </div>

       <!-- VISTA 3: MODALITÀ FLASHCARD -->
       <div id="flashcard-view" class="view w-full">
           <h1 class="text-3xl font-bold text-center mb-2">Flashcard</h1>
           <p id="flashcard-instruction" class="text-center text-gray-500 mb-4">Clicca sulla card per girarla.</p>
           <div class="perspective-1000 w-full h-64 md:h-72 mb-4">
               <div id="flashcard" class="flashcard-inner w-full h-full cursor-pointer rounded-2xl">
                   <div id="card-front" class="flashcard-front bg-white border-2 border-blue-200">
                       <p class="text-2xl md:text-3xl font-semibold"></p>
                   </div>
                   <div id="card-back" class="flashcard-back bg-blue-600 text-white">
                       <p class="text-2xl md:text-3xl font-semibold"></p>
                   </div>
               </div>
           </div>
           <div class="flex flex-col sm:flex-row gap-4 justify-center">
               <button id="swap-lang-btn-flashcard" class="w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-5 rounded-lg">Inverti</button>
               <button id="next-card-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg">Prossima →</button>
               <button id="quick-chat-flashcard-btn" class="w-full sm:w-auto bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-5 rounded-lg">Chiedi all'AI</button>
           </div>
           <div id="card-counter" class="text-center text-gray-500 mt-4"></div>
           <button id="back-to-menu-flashcard" class="block mx-auto mt-4 text-gray-500 hover:text-blue-600 transition">← Torna al Menu</button>
       </div>

       <!-- VISTA 4: MODALITÀ QUIZ -->
       <div id="quiz-view" class="view w-full">
           <h1 class="text-3xl font-bold text-center mb-2">Quiz</h1>
           <p id="quiz-instruction" class="text-center text-gray-500 mb-4">Scegli la traduzione corretta.</p>
           <div class="bg-white p-6 rounded-2xl shadow-lg">
               <div id="quiz-question-container" class="text-center mb-6">
                   <p class="text-lg text-gray-500 mb-1">Traduci:</p>
                   <p id="quiz-question" class="text-2xl md:text-3xl font-bold"></p>
               </div>
               <div id="quiz-options" class="grid grid-cols-2 gap-3"></div>
               <p id="quiz-feedback" class="text-center font-bold mt-4 h-6"></p>
           </div>
           <div class="flex flex-col sm:flex-row gap-4 justify-center mt-4">
               <button id="swap-lang-btn-quiz" class="w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-5 rounded-lg">Inverti</button>
               <button id="next-question-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg hidden">Prossima →</button>
               <button id="quick-chat-quiz-btn" class="w-full sm:w-auto bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-5 rounded-lg">Chiedi all'AI</button>
           </div>
           <button id="back-to-menu-quiz" class="block mx-auto mt-4 text-gray-500 hover:text-blue-600 transition">← Torna al Menu</button>
       </div>
       
       <!-- VISTA 5: MODALITÀ ABBINAMENTO -->
       <div id="match-view" class="view w-full">
           <h1 class="text-3xl font-bold text-center mb-2">Abbina le Coppie</h1>
           <p id="match-instruction" class="text-center text-gray-500 mb-4">Abbina le parole. Ne mancano <span id="match-remaining-count" class="font-bold"></span>.</p>
           <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col md:flex-row gap-4 justify-center items-center">
               <div id="match-english-column" class="flex-1 w-full md:w-auto space-y-2"></div>
               <div class="w-full h-px bg-blue-500 md:w-px md:h-auto md:my-0 md:mx-4"></div>
               <div id="match-italian-column" class="flex-1 w-full md:w-auto space-y-2"></div>
           </div>
           <div class="flex flex-col sm:flex-row gap-4 justify-center mt-4">
               <button id="next-match-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg hidden">Prossimo Set →</button>
               <button id="restart-match-btn" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-5 rounded-lg">Ricomincia</button>
               <button id="quick-chat-match-btn" class="w-full sm:w-auto bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-5 rounded-lg">Chiedi all'AI</button>
           </div>
           <button id="back-to-menu-match" class="block mx-auto mt-4 text-gray-500 hover:text-blue-600 transition">← Torna al Menu</button>
       </div>

        <!-- VISTA 6: CHATBOT AI -->
        <div id="chat-view" class="view w-full">
            <h1 class="text-3xl font-bold text-center mb-2">Pratica con l'AI</h1>
            <p class="text-center text-gray-500 mb-4">Fai conversazione, chiedi traduzioni o grammatica.</p>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div id="chat-window" class="w-full bg-gray-100 rounded-lg p-4 border border-gray-200 mb-4"></div>
                <div class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow p-3 border border-gray-300 rounded-lg" placeholder="Scrivi il tuo messaggio...">
                    <button id="chat-send-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg">Invia</button>
                </div>
            </div>
            <button id="back-to-menu-chat" class="block mx-auto mt-4 text-gray-500 hover:text-blue-600 transition">← Torna al Menu</button>
        </div>
        <footer class="text-center text-gray-400 text-xs mt-4 pb-4">
            <p>Creata da Gabriele Ottonelli</p>
        </footer>
   </main>

   <!-- MODALI -->
   <div id="save-list-modal" class="fixed inset-0 flex items-center justify-center z-50 p-4 hidden">
       <div class="text-overlay absolute inset-0"></div>
       <div class="modal-dialog bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm z-50">
           <h2 class="text-xl font-bold mb-4">Salva la tua lista</h2>
           <input type="text" id="list-name-input" placeholder="Nome della lista" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
           <div class="flex justify-end space-x-2">
               <button id="cancel-save-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Annulla</button>
               <button id="confirm-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salva</button>
           </div>
       </div>
   </div>

   <div id="settings-modal" class="fixed inset-0 flex items-center justify-center z-50 p-4 hidden">
       <div class="text-overlay absolute inset-0"></div>
       <div class="modal-dialog bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm z-50">
           <h2 class="text-xl font-bold mb-4">Impostazioni</h2>
           <div class="space-y-4">
               <div>
                   <label class="block text-gray-700 font-medium mb-1">Ordine Flashcard:</label>
                   <div class="flex items-center space-x-4">
                       <label class="inline-flex items-center"><input type="radio" name="flashcard-order" value="random" checked class="form-radio text-blue-600"><span class="ml-2">Casuale</span></label>
                       <label class="inline-flex items-center"><input type="radio" name="flashcard-order" value="sequential" class="form-radio text-blue-600"><span class="ml-2">Sequenziale</span></label>
                   </div>
               </div>
               <div>
                   <label for="quiz-options-count" class="block text-gray-700 font-medium mb-1">Numero di opzioni del quiz:</label>
                   <select id="quiz-options-count" class="w-full p-2 border border-gray-300 rounded-lg">
                       <option value="4">4</option>
                       <option value="6">6</option>
                       <option value="8">8</option>
                   </select>
               </div>
           </div>
           <div class="flex justify-end space-x-2 mt-6">
               <button id="close-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Chiudi</button>
           </div>
       </div>
   </div>

    <div id="quick-chat-modal" class="fixed inset-0 flex items-center justify-center z-50 p-4 hidden">
        <div class="text-overlay absolute inset-0"></div>
        <div class="modal-dialog bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm z-50">
            <h2 class="text-xl font-bold mb-4">Quick Chat AI</h2>
            <div id="quick-chat-window" class="w-full bg-gray-100 rounded-lg p-4 border mb-4" style="height: 300px; overflow-y: auto;"></div>
            <div class="flex gap-2">
                <input type="text" id="quick-chat-input" class="flex-grow p-3 border rounded-lg" placeholder="Fai una domanda...">
                <button id="quick-chat-send-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Invia</button>
            </div>
            <button id="close-quick-chat-btn" class="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Chiudi</button>
        </div>
    </div>

   <script>
       // Stato dell'applicazione
       let allCards = [];
       let incorrectAnswers = [];
       let currentIndex = -1;
       let italianFirst = true;
       let currentQuizAnswer = '';
       let currentQuizCard = null;
       let currentListName = '';
       let flashcardOrder = 'random';
       let quizOptionsCount = 4;
       let selectedMatchCard = null;
       let cardsToMatch = [];
       let cardsMatched = [];
       let chatContext = "";

       // --- INIZIALIZZAZIONE ---
       document.addEventListener('DOMContentLoaded', () => {
           // Selezione elementi DOM
           const views = document.querySelectorAll('.view');
           const dataInput = document.getElementById('data-input');
           const loadDataBtn = document.getElementById('load-data-btn');
           const aiGenerateListBtn = document.getElementById('ai-generate-list-btn');
           const dataError = document.getElementById('data-error');
           const selectFlashcardModeBtn = document.getElementById('select-flashcard-mode');
           const selectQuizModeBtn = document.getElementById('select-quiz-mode');
           const selectMatchModeBtn = document.getElementById('select-match-mode');
           const selectChatModeBtn = document.getElementById('select-chat-mode');
           const selectReviewModeBtn = document.getElementById('select-review-mode');
           const backToDataBtn = document.getElementById('back-to-data-btn');
           const flashcard = document.getElementById('flashcard');
           const cardFrontText = document.querySelector('#card-front p');
           const cardBackText = document.querySelector('#card-back p');
           const nextCardBtn = document.getElementById('next-card-btn');
           const swapLangBtnFlashcard = document.getElementById('swap-lang-btn-flashcard');
           const cardCounter = document.getElementById('card-counter');
           const flashcardInstruction = document.getElementById('flashcard-instruction');
           const backToMenuFlashcard = document.getElementById('back-to-menu-flashcard');
           const quizQuestion = document.getElementById('quiz-question');
           const quizOptionsContainer = document.getElementById('quiz-options');
           const quizFeedback = document.getElementById('quiz-feedback');
           const nextQuestionBtn = document.getElementById('next-question-btn');
           const swapLangBtnQuiz = document.getElementById('swap-lang-btn-quiz');
           const quizInstruction = document.getElementById('quiz-instruction');
           const backToMenuQuiz = document.getElementById('back-to-menu-quiz');
           const savedListsSelect = document.getElementById('saved-lists-select');
           const loadSavedListBtn = document.getElementById('load-saved-list-btn');
           const deleteListBtn = document.getElementById('delete-list-btn');
           const matchEnglishColumn = document.getElementById('match-english-column');
           const matchItalianColumn = document.getElementById('match-italian-column');
           const nextMatchBtn = document.getElementById('next-match-btn');
           const restartMatchBtn = document.getElementById('restart-match-btn');
           const backToMenuMatch = document.getElementById('back-to-menu-match');
           const matchRemainingCount = document.getElementById('match-remaining-count');
           const apiKeyInputMain = document.getElementById('api-key-input-main');
           const saveApiKeyCheckboxMain = document.getElementById('save-api-key-checkbox-main');
           const chatWindow = document.getElementById('chat-window');
           const chatInput = document.getElementById('chat-input');
           const chatSendBtn = document.getElementById('chat-send-btn');
           const backToMenuChat = document.getElementById('back-to-menu-chat');
           const saveListModal = document.getElementById('save-list-modal');
           const listNameInput = document.getElementById('list-name-input');
           const confirmSaveBtn = document.getElementById('confirm-save-btn');
           const cancelSaveBtn = document.getElementById('cancel-save-btn');
           const settingsBtn = document.getElementById('settings-btn');
           const settingsModal = document.getElementById('settings-modal');
           const closeSettingsBtn = document.getElementById('close-settings-btn');
           const flashcardOrderRadios = document.querySelectorAll('input[name="flashcard-order"]');
           const quizOptionsCountSelect = document.getElementById('quiz-options-count');
           const quickChatModal = document.getElementById('quick-chat-modal');
           const quickChatWindow = document.getElementById('quick-chat-window');
           const quickChatInput = document.getElementById('quick-chat-input');
           const quickChatSendBtn = document.getElementById('quick-chat-send-btn');
           const closeQuickChatBtn = document.getElementById('close-quick-chat-btn');
           const quickChatFlashcardBtn = document.getElementById('quick-chat-flashcard-btn');
           const quickChatQuizBtn = document.getElementById('quick-chat-quiz-btn');
           const quickChatMatchBtn = document.getElementById('quick-chat-match-btn');

           // --- FUNZIONI DI GESTIONE VISTE E MODALI ---
           const showView = (viewId) => {
               views.forEach(view => view.classList.remove('active'));
               document.getElementById(viewId).classList.add('active');
               settingsBtn.classList.toggle('hidden', viewId === 'data-entry-view');
           }

           const showModal = (modalElement) => {
               modalElement.classList.remove('hidden');
               setTimeout(() => modalElement.querySelector('.modal-dialog').classList.add('show'), 10);
           }

           const hideModal = (modalElement) => {
               modalElement.querySelector('.modal-dialog').classList.remove('show');
               setTimeout(() => modalElement.classList.add('hidden'), 300);
           }

           // --- LOGICA DI CARICAMENTO DATI ---
           const handleLoadData = () => {
               const parsedCards = parseData(dataInput.value);
               if (parsedCards.length >= Math.max(parseInt(quizOptionsCountSelect.value), 4)) {
                   allCards = parsedCards;
                   incorrectAnswers = [];
                   currentListName = '';
                   dataError.classList.add('hidden');
                   showModal(saveListModal);
               } else {
                   dataError.textContent = `Per favore, inserisci almeno ${Math.max(parseInt(quizOptionsCountSelect.value), 4)} voci valide.`;
                   dataError.classList.remove('hidden');
               }
           }

           const parseData = (data) => {
               return data.trim().split('\n')
                   .map(line => {
                       const parts = line.split('==');
                       if (parts.length === 2 && parts[0].trim() && parts[1].trim()) {
                           return { english: parts[0].trim(), italian: parts[1].trim() };
                       }
                       return null;
                   })
                   .filter(card => card !== null);
           }

           // --- GESTIONE LISTE CON LOCAL STORAGE ---
           const saveList = (name, cards) => {
               const lists = JSON.parse(localStorage.getItem('flashcardLists')) || {};
               lists[name] = cards;
               localStorage.setItem('flashcardLists', JSON.stringify(lists));
               loadSavedLists();
               currentListName = name;
           }

           const loadList = (name) => {
               const lists = JSON.parse(localStorage.getItem('flashcardLists')) || {};
               if (lists[name]) {
                   allCards = lists[name];
                   dataInput.value = allCards.map(c => `${c.english}==${c.italian}`).join('\n');
                   incorrectAnswers = [];
                   currentListName = name;
                   dataError.classList.add('hidden');
                   showView('mode-selection-view');
                   selectReviewModeBtn.classList.add('hidden');
               }
           }

           const deleteList = (name) => {
               if (confirm(`Sei sicuro di voler cancellare la lista "${name}"?`)) {
                   const lists = JSON.parse(localStorage.getItem('flashcardLists')) || {};
                   delete lists[name];
                   localStorage.setItem('flashcardLists', JSON.stringify(lists));
                   loadSavedLists();
               }
           }

           const loadSavedLists = () => {
               const lists = JSON.parse(localStorage.getItem('flashcardLists')) || {};
               savedListsSelect.innerHTML = '<option value="">-- Seleziona --</option>';
               const listNames = Object.keys(lists);
               listNames.forEach(name => {
                   const option = document.createElement('option');
                   option.value = name;
                   option.textContent = name;
                   savedListsSelect.appendChild(option);
               });
               loadSavedListBtn.disabled = listNames.length === 0;
               deleteListBtn.disabled = listNames.length === 0;
           }

           // --- LOGICA CHATBOT (UNIFICATA) ---
           const openQuickChat = (initialBotMessage) => {
               quickChatWindow.innerHTML = '';
               appendQuickChatMessage(initialBotMessage, 'bot');
               showModal(quickChatModal);
           }

           const openAIGenerateListChat = () => {
               chatContext = "GENERATE_LIST";
               openQuickChat("Ciao! Che tipo di lista di vocaboli vuoi creare? (es. `animali`, `cibo`, `verbi comuni`)");
           }

           const handleQuickChatSend = async () => {
               const userMessage = quickChatInput.value.trim();
               const apiKey = apiKeyInputMain.value.trim();
               if (!apiKey) {
                   alert('Per favore, inserisci la tua chiave API di Google AI per continuare.');
                   return;
               }
               if (!userMessage) return;

               appendQuickChatMessage(userMessage, 'user');
               quickChatInput.value = '';
               appendQuickChatMessage('...', 'bot', true);

               try {
                   let responseText;
                   if (chatContext === "GENERATE_LIST") {
                       const prompt = `Sei un assistente per l'apprendimento delle lingue. Crea una lista di 15 vocaboli sul tema "${userMessage}". Rispondi SOLO con la lista nel formato 'Inglese==Italiano', una voce per riga. Non aggiungere altre frasi o spiegazioni.`;
                       responseText = await callGeminiAPI(prompt, apiKey);
                       dataInput.value = responseText;
                       appendQuickChatMessage("Ecco la tua lista! L'ho inserita nell'area di testo. Puoi modificarla o cliccare 'Inizia'.", 'bot');
                   } else {
                       const prompt = `${chatContext}\n\nDomanda utente: "${userMessage}"\n\nRispondi alla domanda dell'utente in modo conciso e utile per chi impara l'inglese.`;
                       responseText = await callGeminiAPI(prompt, apiKey);
                       appendQuickChatMessage(responseText, 'bot');
                   }
               } catch (error) {
                   appendQuickChatMessage(`Si è verificato un errore: ${error.message}.`, 'bot');
               } finally {
                   removeTypingIndicator(quickChatWindow);
               }
           }

            const handleMainChatSend = async () => {
                const userMessage = chatInput.value.trim();
                const apiKey = apiKeyInputMain.value.trim();
                if (!apiKey) {
                    alert('Per favore, inserisci la tua chiave API di Google AI per continuare.');
                    return;
                }
                if (!userMessage) return;

                appendMainChatMessage(userMessage, 'user');
                chatInput.value = '';
                appendMainChatMessage('...', 'bot', true);

                try {
                    const prompt = `Sei un assistente AI generico. Rispondi alla domanda dell'utente. Domanda: "${userMessage}"`;
                    const responseText = await callGeminiAPI(prompt, apiKey);
                    appendMainChatMessage(responseText, 'bot');
                } catch (error) {
                    appendMainChatMessage(`Si è verificato un errore: ${error.message}.`, 'bot');
                } finally {
                    removeTypingIndicator(chatWindow);
                }
            }

           const callGeminiAPI = async (prompt, apiKey) => {
               const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
               const response = await fetch(API_URL, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
               });
               if (!response.ok) {
                   const errorData = await response.json();
                   throw new Error(errorData.error.message || 'Errore API');
               }
               const data = await response.json();
               return data.candidates[0].content.parts[0].text;
           }

           const appendQuickChatMessage = (text, sender, isTyping = false) => {
               appendMessage(text, sender, quickChatWindow, isTyping);
           }
           const appendMainChatMessage = (text, sender, isTyping = false) => {
               appendMessage(text, sender, chatWindow, isTyping);
           }

           const appendMessage = (text, sender, windowElement, isTyping = false) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `${sender}-message`;
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                if (isTyping) bubble.id = `typing-indicator-${windowElement.id}`;
                messageDiv.appendChild(bubble);
                windowElement.appendChild(messageDiv);
                windowElement.scrollTop = windowElement.scrollHeight;
           }

           const removeTypingIndicator = (windowElement) => {
               const indicator = document.getElementById(`typing-indicator-${windowElement.id}`);
               if (indicator) indicator.parentElement.remove();
           }

           // --- LOGICA FLASHCARD ---
           const setupFlashcardMode = (cards) => {
               currentIndex = -1;
               updateFlashcardInstruction();
               showNextCard(cards);
           }

           const showNextCard = (cards, animate = true) => {
               if (flashcardOrder === 'sequential') {
                   currentIndex = (currentIndex + 1) % cards.length;
               } else {
                   currentIndex = Math.floor(Math.random() * cards.length);
               }
               const card = cards[currentIndex];
               if (animate) flashcard.classList.remove('is-flipped');
               setTimeout(() => {
                   cardFrontText.textContent = italianFirst ? card.italian : card.english;
                   cardBackText.textContent = italianFirst ? card.english : card.italian;
               }, animate ? 150 : 0);
               cardCounter.textContent = `Card ${currentIndex + 1} di ${cards.length}`;
           }

           const updateFlashcardInstruction = () => {
               flashcardInstruction.textContent = italianFirst ? 'Italiano → Inglese' : 'Inglese → Italiano';
           }

           // --- LOGICA QUIZ ---
           const setupQuizMode = (cardsToQuiz) => {
               if (cardsToQuiz === incorrectAnswers) {
                   swapLangBtnQuiz.style.display = 'none';
                   quizInstruction.textContent = `Rivedi i tuoi ${incorrectAnswers.length} errori!`;
               } else {
                   swapLangBtnQuiz.style.display = 'block';
                   updateQuizInstruction();
               }
               generateQuizQuestion(cardsToQuiz);
           }

           const updateQuizInstruction = () => {
               quizInstruction.textContent = italianFirst ? 'Italiano → Inglese' : 'Inglese → Italiano';
           }

           const generateQuizQuestion = (cardsToQuiz) => {
               quizFeedback.textContent = '';
               nextQuestionBtn.classList.add('hidden');
               swapLangBtnQuiz.disabled = false;

               if (cardsToQuiz.length === 0) {
                   quizFeedback.textContent = 'Hai corretto tutti gli errori! 🎉';
                   setTimeout(() => backToMenuQuiz.click(), 2000);
                   return;
               }

               const correctCardIndex = Math.floor(Math.random() * cardsToQuiz.length);
               const correctCard = cardsToQuiz[correctCardIndex];
               currentQuizCard = correctCard;

               const questionTerm = italianFirst ? correctCard.italian : correctCard.english;
               currentQuizAnswer = italianFirst ? correctCard.english : correctCard.italian;
               quizQuestion.textContent = questionTerm;

               let options = [correctCard];
               const otherCards = allCards.filter(card => card !== correctCard);
               otherCards.sort(() => 0.5 - Math.random());
               for (let i = 0; i < parseInt(quizOptionsCountSelect.value) - 1 && i < otherCards.length; i++) {
                   options.push(otherCards[i]);
               }
               options.sort(() => 0.5 - Math.random());

               quizOptionsContainer.innerHTML = '';
               options.forEach(card => {
                   const button = document.createElement('button');
                   button.className = "quiz-option w-full p-3 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 transition text-sm md:text-base text-gray-800";
                   button.textContent = italianFirst ? card.english : card.italian;
                   button.addEventListener('click', handleAnswerClick);
                   quizOptionsContainer.appendChild(button);
               });
           }

           const handleAnswerClick = (event) => {
               const selectedButton = event.target;
               const selectedAnswer = selectedButton.textContent;
               swapLangBtnQuiz.disabled = true;

               const allButtons = quizOptionsContainer.querySelectorAll('button');
               allButtons.forEach(btn => btn.disabled = true);

               const correctAnswerButton = Array.from(allButtons).find(btn => btn.textContent === currentQuizAnswer);

               if (selectedAnswer === currentQuizAnswer) {
                   quizFeedback.textContent = 'Corretto! 🎉';
                   quizFeedback.className = 'text-center font-bold mt-4 h-6 text-green-600';
                   selectedButton.classList.add('selected-correct');
                   if (incorrectAnswers.includes(currentQuizCard)) {
                       incorrectAnswers = incorrectAnswers.filter(card => card !== currentQuizCard);
                   }
               } else {
                   quizFeedback.textContent = 'Sbagliato. 😕';
                   quizFeedback.className = 'text-center font-bold mt-4 h-6 text-red-600';
                   selectedButton.classList.add('selected-incorrect');
                   if(correctAnswerButton) correctAnswerButton.classList.add('correct-answer');
                   if (currentQuizCard && !incorrectAnswers.includes(currentQuizCard)) {
                       incorrectAnswers.push(currentQuizCard);
                   }
               }
               nextQuestionBtn.classList.remove('hidden');
           }

           // --- LOGICA GIOCO ABBINAMENTO ---
           const setupMatchMode = () => {
               selectedMatchCard = null;
               cardsToMatch = [...allCards].sort(() => 0.5 - Math.random());
               cardsMatched = [];
               loadNextMatchSet();
           }

           const loadNextMatchSet = () => {
               matchEnglishColumn.innerHTML = '';
               matchItalianColumn.innerHTML = '';
               selectedMatchCard = null;
               
               const remainingCards = cardsToMatch.filter(card => !cardsMatched.includes(card.english));
               
               if (remainingCards.length === 0) {
                   matchEnglishColumn.innerHTML = '<p class="text-center text-xl text-green-600 font-bold">Hai abbinato tutte le coppie! 🎉</p>';
                   nextMatchBtn.classList.add('hidden');
                   matchRemainingCount.textContent = '0';
                   return;
               }
               
               nextMatchBtn.classList.add('hidden');
               const setSize = Math.min(4, remainingCards.length);
               const currentSet = remainingCards.slice(0, setSize);
               
               const englishWords = currentSet.map(c => c.english).sort(() => 0.5 - Math.random());
               const italianWords = currentSet.map(c => c.italian).sort(() => 0.5 - Math.random());
               
               englishWords.forEach(word => createMatchButton(word, 'english', matchEnglishColumn));
               italianWords.forEach(word => createMatchButton(word, 'italian', matchItalianColumn));

               matchRemainingCount.textContent = remainingCards.length;
           }

           const createMatchButton = (word, lang, column) => {
                const button = document.createElement('button');
                button.className = "match-option w-full p-3 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 transition text-sm md:text-base text-gray-800";
                button.textContent = word;
                button.dataset.word = word;
                button.dataset.lang = lang;
                button.addEventListener('click', handleMatchClick);
                column.appendChild(button);
           }

           const handleMatchClick = (event) => {
               const clickedButton = event.target;
               if (clickedButton.classList.contains('matched')) return;
               
               if (selectedMatchCard) {
                   if (selectedMatchCard === clickedButton) {
                       selectedMatchCard.classList.remove('selected');
                       selectedMatchCard = null;
                       return;
                   }
                   
                   if (selectedMatchCard.dataset.lang === clickedButton.dataset.lang) {
                       selectedMatchCard.classList.remove('selected');
                       selectedMatchCard = clickedButton;
                       clickedButton.classList.add('selected');
                       return;
                   }
                   
                   const englishWord = selectedMatchCard.dataset.lang === 'english' ? selectedMatchCard.dataset.word : clickedButton.dataset.word;
                   const italianWord = selectedMatchCard.dataset.lang === 'italian' ? selectedMatchCard.dataset.word : clickedButton.dataset.word;
                   
                   const originalCard = allCards.find(c => c.english === englishWord && c.italian === italianWord);
                   
                   if (originalCard) {
                       clickedButton.classList.add('matched');
                       selectedMatchCard.classList.add('matched');
                       selectedMatchCard.classList.remove('selected');
                       selectedMatchCard = null;
                       cardsMatched.push(englishWord);
                       
                       if (cardsMatched.length % 4 === 0 || cardsMatched.length === allCards.length) {
                           nextMatchBtn.classList.remove('hidden');
                           if (cardsMatched.length === allCards.length) {
                               nextMatchBtn.textContent = 'Hai finito! 🎉';
                               nextMatchBtn.disabled = true;
                           }
                       }
                   } else {
                       clickedButton.classList.add('bg-red-500', 'text-white');
                       selectedMatchCard.classList.add('bg-red-500', 'text-white');
                       setTimeout(() => {
                           clickedButton.classList.remove('bg-red-500', 'text-white');
                           selectedMatchCard.classList.remove('bg-red-500', 'text-white', 'selected');
                           selectedMatchCard = null;
                       }, 500);
                   }
               } else {
                   selectedMatchCard = clickedButton;
                   selectedMatchCard.classList.add('selected');
               }
           }

           // INIZIALIZZAZIONE VISTA E DATI
           showView('data-entry-view');
           loadSavedLists();
           const savedKey = localStorage.getItem('google_ai_api_key');
           if (savedKey) {
               apiKeyInputMain.value = savedKey;
               saveApiKeyCheckboxMain.checked = true;
           }

           // EVENT LISTENERS
           loadDataBtn.addEventListener('click', handleLoadData);
           backToDataBtn.addEventListener('click', () => showView('data-entry-view'));
           selectFlashcardModeBtn.addEventListener('click', () => { setupFlashcardMode(allCards); showView('flashcard-view'); });
           selectQuizModeBtn.addEventListener('click', () => { setupQuizMode(allCards); showView('quiz-view'); });
           selectMatchModeBtn.addEventListener('click', () => { setupMatchMode(); showView('match-view'); });
           selectChatModeBtn.addEventListener('click', () => { chatContext = ''; showView('chat-view'); });
           selectReviewModeBtn.addEventListener('click', () => { setupQuizMode(incorrectAnswers); showView('quiz-view'); }); // FIX: Passa `incorrectAnswers`
           loadSavedListBtn.addEventListener('click', () => { if(savedListsSelect.value) loadList(savedListsSelect.value); });
           deleteListBtn.addEventListener('click', () => { if(savedListsSelect.value) deleteList(savedListsSelect.value); });
           confirmSaveBtn.addEventListener('click', () => {
               const listName = listNameInput.value.trim();
               if (listName) {
                   saveList(listName, allCards);
                   hideModal(saveListModal);
                   showView('mode-selection-view');
               }
           });
           cancelSaveBtn.addEventListener('click', () => hideModal(saveListModal));
           settingsBtn.addEventListener('click', () => showModal(settingsModal));
           closeSettingsBtn.addEventListener('click', () => hideModal(settingsModal));
           flashcardOrderRadios.forEach(radio => radio.addEventListener('change', (e) => flashcardOrder = e.target.value));
           quizOptionsCountSelect.addEventListener('change', (e) => quizOptionsCount = parseInt(e.target.value));
           saveApiKeyCheckboxMain.addEventListener('change', () => {
                if (saveApiKeyCheckboxMain.checked) {
                   localStorage.setItem('google_ai_api_key', apiKeyInputMain.value.trim());
               } else {
                   localStorage.removeItem('google_ai_api_key');
               }
           });
           aiGenerateListBtn.addEventListener('click', openAIGenerateListChat);
           quickChatSendBtn.addEventListener('click', handleQuickChatSend);
           quickChatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleQuickChatSend(); });
           chatSendBtn.addEventListener('click', handleMainChatSend); // FIX: Aggiunto listener
           chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleMainChatSend(); }); // FIX: Aggiunto listener
           closeQuickChatBtn.addEventListener('click', () => hideModal(quickChatModal));
           quickChatFlashcardBtn.addEventListener('click', () => {
               if (currentIndex === -1 || !allCards[currentIndex]) {
                   alert("Per favore, visualizza almeno una carta prima di usare l'AI.");
                   return;
               }
               const currentCard = allCards[currentIndex];
               chatContext = `Riguardo alla parola "${currentCard.english}" (che significa "${currentCard.italian}"), rispondi alla seguente domanda:`
               openQuickChat(`Cosa vuoi sapere su **${currentCard.english}**?`);
           });
           quickChatQuizBtn.addEventListener('click', () => {
               if (!currentQuizCard) {
                   alert("Attendi la prossima domanda prima di usare l'AI.");
                   return;
               }
               const currentCard = currentQuizCard;
               chatContext = `Riguardo alla parola "${currentCard.english}" (che significa "${currentCard.italian}"), rispondi alla seguente domanda:`
               openQuickChat(`Cosa vuoi sapere sulla domanda del quiz?`);
           });
           quickChatMatchBtn.addEventListener('click', () => {
               chatContext = `Sto giocando al gioco di abbinamento. Le parole rimanenti sono: ${cardsToMatch.filter(c => !cardsMatched.includes(c.english)).map(c=>c.english).join(', ')}. Rispondi alla seguente domanda:`
               openQuickChat('Cosa vuoi chiedere sul gioco di abbinamento?');
           });
           backToMenuFlashcard.addEventListener('click', () => showView('mode-selection-view'));
           backToMenuQuiz.addEventListener('click', () => {
               if (incorrectAnswers.length > 0) {
                   selectReviewModeBtn.classList.remove('hidden');
               } else {
                   selectReviewModeBtn.classList.add('hidden');
               }
               showView('mode-selection-view');
           });
           backToMenuMatch.addEventListener('click', () => showView('mode-selection-view'));
           backToMenuChat.addEventListener('click', () => showView('mode-selection-view'));
           flashcard.addEventListener('click', () => flashcard.classList.toggle('is-flipped'));
           nextCardBtn.addEventListener('click', () => showNextCard(allCards));
           swapLangBtnFlashcard.addEventListener('click', () => {
               italianFirst = !italianFirst;
               updateFlashcardInstruction();
               showNextCard(allCards, false);
           });
           nextQuestionBtn.addEventListener('click', () => {
               const cardsToQuiz = quizInstruction.textContent.includes('errori') ? incorrectAnswers : allCards;
               generateQuizQuestion(cardsToQuiz);
           });
           swapLangBtnQuiz.addEventListener('click', () => {
               italianFirst = !italianFirst;
               updateQuizInstruction();
               generateQuizQuestion(allCards);
           });
           nextMatchBtn.addEventListener('click', loadNextMatchSet);
           restartMatchBtn.addEventListener('click', () => {
               if (confirm("Sei sicuro di voler ricominciare?")) setupMatchMode();
           });
       });
   </script>
</body>
</html>